<template>
  <div class="page">
    <div class="navbar color-theme-red">
      <div class="navbar-inner">
        <div class="left">
          <a href="#" class="link panel-open" data-panel="left">
            <i class="icon f7-icons if-ios">menu</i>
            <i class="icon material-icons if-md">menu</i>
          </a>
        </div>
        <div class="center">

          <!--a className='flex-parent-inline btn color-blue color-white-on-active bg-transparent bg-darken10-on-hover bg-blue-on-active txt-s ml3'
            href='#'-->
            <span>Reporte de actividad en campo</span> AVP
          <!--/a-->
        </div>


      </div>
    </div>
    <div class="page-content">
      <div class="block">
        <div class="row">
          <a class="link" href="/menu/">
            <i class="material-icons">
              assignment_return
            </i>
            <span>Regresar al menú principal</span>
          </a>
        </div>

        <form class="list" id="frmCampo" name="frmCampo">
          <div class="block-title">PROFESIONAL</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">DNI</div>
                  <div class="item-input-wrap disabled">
                    <input id="dni" name="dni" type="text" placeholder="Ingrese el DNI">
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Nombre</div>
                  <div class="item-input-wrap disabled">
                    <input id="nombre" name="nombre" type="text" placeholder="Ingrese el nombre">
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">GRUPO DE TRABAJO</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <!--div class="item-title item-label">Vía</div-->
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="grupo_trabajo" name="grupo_trabajo" placeholder="Seleccione el grupo...">
                      <option value="Inteferencias">Interferencias</option>
                      <option value="Otros">Otros</option>
                    </select>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">FECHA</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <!--div class="item-title item-label">Vía</div-->
                  <div class="item-input-wrap">
                    <input id="fecha" name="fecha" type="date" value="2014-04-30" placeholder="Seleccione una fecha...">
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">HORARIO DE ACTIVIDADES EN ÁREA SE ESTUDIO</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Hora de Inicio de Actividades</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="inicioacthora" name="inicioacthora" placeholder="Seleccione la hora...">
                    </select>
                  </div>
                </div>
                <div class="item-inner">
                  <div class="item-title item-label">Minuto de Inicio de Actividades</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="inicioactminuto" name="inicioactminuto" placeholder="Seleccione el minuto...">
                    </select>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Hora de Fin de Actividades</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="finacthora" name="finacthora" placeholder="Seleccione la hora...">
                    </select>
                  </div>
                </div>
                <div class="item-inner">
                  <div class="item-title item-label">Minuto de Fin de Actividades</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="finactminuto" name="finactminuto" placeholder="Seleccione el minuto...">
                    </select>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">ÁREA DE ESTUDIO / TRABAJO</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">* Tramo</div>
                  <div class="item-input-wrap">
                    <input id="tramo" name="tramo" type="text" placeholder="Ingrese el tramo" required validate data-error-message="Debe ingresar el valor para el tramo">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">* Sector</div>
                  <div class="item-input-wrap">
                    <input id="sector" name="sector" type="text" placeholder="Ingrese el sector" required validate data-error-message="Debe ingresar el valor para el sector">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">* Vía</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="tipovia" name="tipovia" placeholder="Seleccione la vía..." required validate data-error-message="Debe seleccionar el tipo de vía">
                      <option value="AV">AV</option>
                      <option value="CA">CA</option>
                      <option value="JR">JR</option>
                    </select>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">* Nombre</div>
                  <div class="item-input-wrap">
                    <input id="nombrecalle" name="nombrecalle" type="text" placeholder="Ingrese el Nombre de la calle / vía / jirón" required validate data-error-message="Debe ingresar el nombre de la vía">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">* Cuadras</div>
                  <div class="item-input-wrap">
                    <input id="cuadras" name="cuadras" type="text" placeholder="Ingrese las cuadras"  required validate data-error-message="Debe ingresar el valor para las cuadras">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">* Referencia</div>
                  <div class="item-input-wrap">
                    <input id="referencia" name="referencia" type="text" placeholder="Ingrese la referencia" required validate data-error-message="Debe ingresar el valor de referencia">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">ACTIVIDAD</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Tipo</div>
                  <div class="item-inpuct-wrap input-dropdown-wrap">
                    <select id="tipoactividad" name="tipoactividad" placeholder="Seleccione el tipo de actividad...">
                      <option value="LEVANTAMIENTO">LEVANTAMIENTO</option>
                      <option value="VERIFICACIÓN">VERIFICACIÓN</option>
                      <option value="REPLANTEO">REPLANTEO</option>
                      <option value="ACTUALIZACIÓN">ACTUALIZACIÓN</option>
                      <option value="VALORIZACIÓN">VALORIZACIÓN</option>
                      <option value="COORDINACIÓN">COORDINACIÓN</option>
                      <option value="OTROS">OTROS</option>
                    </select>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Detalle</div>
                  <div class="item-input-wrap">
                    <input id="detalleact" name="detalleact" type="text" placeholder="Ingrese el detalle">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">EQUIPO UTILIZADO</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Equipo</div>
                  <div class="item-inpuct-wrap input-dropdown-wrap">
                    <select id="equipo" name="equipo" placeholder="Seleccione el equipo utilizado">
                      <option value="EST TOTAL">EST TOTAL</option>
                      <option value="GPS">GPS</option>
                      <option value="WINCHA">WINCHA</option>
                      <option value="OTROS">OTROS</option>
                    </select>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Especificar</div>
                  <div class="item-input-wrap">
                    <input id="especificar" name="especificar" type="text" placeholder="Especifique el equipo">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">COORDINACIONES</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Tipo</div>
                  <div class="item-inpuct-wrap input-dropdown-wrap">
                    <select id="tipocoordinacion" name="tipocoordinacion" placeholder="Seleccione el tipo de coordinación...">
                      <option value="FUNCIONARIOS">FUNCIONARIOS</option>
                      <option value="POBLADORES">POBLADORES</option>
                      <option value="OTROS">OTROS</option>
                    </select>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Detalle</div>
                  <div class="item-input-wrap">
                    <input id="detallecoordinacion" name="detallecoordinacion" type="text" placeholder="Ingrese el detalle">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          
          <div class="block-title">OTRAS INCIDENCIAS SURGIDAS DURANTE LA ACTIVIDAD</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Incidencias</div>
                  <div class="item-input-wrap">
                    <input id="incidencias" name="incidencias" type="text" placeholder="Ingrese el detalle de incidencias">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

        </form>
        <div class="list" style="padding: 20px;">
          <div class="text-align-center">
            Al hacer clic, declaro bajo juramento que los datos consignados en este formulario son correctos y completos sin omitir ni falsear dato alguno que deba contener, siendo expresión de la verdad.
          </div>
          <ul>
            <li>
              <span class="block">
              </span>
            </li>
            <li>
              <a id="btnregistrar" @click="registraract" class="col button button-raised button-fill button-round">Registrar actividad</a>
            </li>
          </ul>
          <div class="block-footer">
  
          </div>
        </div>

      </div>
    </div>

  </div>
</template>
<script>
  import $ from "jquery";
  import {objectToString, StringToObject} from '../../helper';
  import {servers} from "../Login/servers";

  export default {
    created() {
    

    },
    on: {
      pageInit: function (event, page) {
        const app = this.$app;
        // llenar Horas
        for(var i = 0; i <= 23; i++) {
          var option = document.createElement('option');
          var option2 = document.createElement('option');
          option.textContent = (i < 10) ? ("0" + i) : i;
          option2.textContent = (i < 10) ? ("0" + i) : i;
          document.querySelector('#inicioacthora').appendChild(option);
          document.querySelector('#finacthora').appendChild(option2);
          
        }
        // llenar Minutos
        for(var i = 0; i <= 59; i++) {
          var option = document.createElement('option');
          var option2 = document.createElement('option');
          option.textContent = (i < 10) ? ("0" + i) : i;
          option2.textContent = (i < 10) ? ("0" + i) : i;
          document.querySelector('#inicioactminuto').appendChild(option);
          document.querySelector('#finactminuto').appendChild(option2);
        }

        let config;
        let nrodni;
        if(localStorage.usuariopersonal != undefined){
          config = JSON.parse(localStorage.usuariopersonal);
          nrodni = config[0].dni;
          $('#dni').val(nrodni);
          $('#nombre').val(config[0].nombres_apellidos);
        }
        //Colocar fecha
        var now = new Date();
        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);
        var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
        $('#fecha').val(today);
        //colocar hora actual
        var d = new Date();
        var hour =  ("0" + (d.getHours())).slice(-2);
        $('#inicioacthora').val(hour);
        var minute = ("0" + (d.getMinutes())).slice(-2);
        $('#inicioactminuto').val(minute);

        //cargar los grupos de trabajo
        let url_server = `http://${servers[2].ipServidor}:${servers[2].puertoServidor}/api`;
        $.get(`${url_server}/brigada`, function(data) {
          if ($.isEmptyObject(data))
          {
            app.dialog.alert("No se pudo encontrar el usuario.");
          }
          else
          {
            $('#grupo_trabajo').empty();
            $.each(data, function(key, value) {   
            $('#grupo_trabajo')
              .append($("<option></option>")
              .attr("value", value.nombre_brigada)
              .text(value.nombre_brigada)); 
            });
          }
        })
        .fail(function() {
          app.dialog.alert("Se encontró un problema en la conexión.");
        });

        //Revisar si hay reporte pendiente
        localStorage.setItem('actividadpendiente', 'false');
        app.dialog.preloader('Cargando...');
        $.get(`${url_server}/actividadcampodni/${nrodni}`, function(data) {
          app.dialog.close();
          if (!$.isEmptyObject(data))
          {
            app.dialog.confirm(`Su reporte ${data[0].id} tiene hora de termino pendiente, ¿desea finalizarlo?`, function () {
              localStorage.setItem('actividadpendiente', 'true');
              localStorage.setItem('idactividadcampo', data[0].id);

              let arraytiempo = data[0].inicioactividades_area_estudio.split(':');
              $('#inicioacthora').val(arraytiempo[0]);
              $('#inicioactminuto').val(arraytiempo[1]);

              $('#grupo_trabajo').val(data[0].grupo_trabajo);
              $('#fecha').val(data[0].fecha);
              $('#tramo').val(data[0].area_est_tramo);
              $('#sector').val(data[0].area_est_sector);
              $('#tipovia').val(data[0].tipo_via);
              $('#nombrecalle').val(data[0].nombre);
              $('#cuadras').val(data[0].cuadras);
              $('#referencia').val(data[0].referencia);
              $('#tipoactividad').val(data[0].tipo_actividad);
              $('#detalleact').val(data[0].detalle_activ);
              $('#equipo').val(data[0].equipo_utilizado);
              $('#especificar').val(data[0].especificar_equipo);
              $('#tipocoordinacion').val(data[0].coordinaciones);
              $('#detallecoordinacion').val(data[0].detalle_coordinaciones);
              $('#incidencias').val(data[0].otrasincidencias);

            }, function () {
            });
          }
        })
        .fail(function() {
          app.dialog.close();
          app.dialog.alert( "Se encontró un problema en la conexión." );
        });

      }
    },

    methods: {
      registraract() {
        const app = this.$app;
        const router = this.$router;
        
        if (!$('form')[0].checkValidity()) {
          app.dialog.alert("Debe completar los campos indicados como requeridos (*)");
          return false;
        }

        app.dialog.confirm("¿Está seguro de enviar el reporte de actividades?", function () {
        }, function () {
          return false;
        });

        let url_server = `http://${servers[2].ipServidor}:${servers[2].puertoServidor}/api`;

        if(localStorage.actividadpendiente != undefined && localStorage.actividadpendiente == 'true'){
          let datosput = {id: `${localStorage.idactividadcampo}`,
                          nombres:`${$('#nombre').val()}`,
                          dni:`${$('#dni').val()}`,
                          inicioactividades_area_estudio:`${$('#inicioacthora').val() + ':' + $('#inicioactminuto').val()}`,
                          termino_actividades_area_estudio:`${$('#finacthora').val() + ':' + $('#finactminuto').val()}`,
                          grupo_trabajo:`${$('#grupo_trabajo').val()}`,
                          fecha:`${$('#fecha').val()}`,
                          area_est_tramo:`${$('#tramo').val()}`,
                          area_est_sector:`${$('#sector').val()}`,
                          tipo_via:`${$('#tipovia').val()}`,
                          nombre:`${$('#nombrecalle').val()}`,
                          cuadras:`${$('#cuadras').val()}`,
                          referencia:`${$('#referencia').val()}`,
                          tipo_actividad:`${$('#tipoactividad').val()}`,
                          detalle_activ:`${$('#detalleact').val()}`,
                          equipo_utilizado:`${$('#equipo').val()}`,
                          especificar_equipo:`${$('#especificar').val()}`,
                          coordinaciones:`${$('#tipocoordinacion').val()}`,
                          detalle_coordinaciones:`${$('#detallecoordinacion').val()}`,
                          otrasincidencias:`${$('#incidencias').val()}`
                          };

          $.ajax({
            url: `${url_server}/actividadcampo`,
            type: 'put',
            data: datosput
          })
          .done(function(data){
            if ($.isEmptyObject(data))
            {
              app.dialog.alert("Se encontró problema al registrar la actividad.");
            }
            else
            {
              let txtMensaje = `Su reporte ${data.id} fue actualizado con éxito.`
              app.dialog.alert(txtMensaje, function () {
                router.navigate('/menu/', {pushState: true});
              });
            }
          }).fail( function() {
            app.dialog.alert( "Se encontró un problema en la conexión.");
          });

          return false;
        }

        let datos = {nombres:`${$('#nombre').val()}`,
                    dni:`${$('#dni').val()}`,
                    inicioactividades_area_estudio:`${$('#inicioacthora').val() + ':' + $('#inicioactminuto').val()}`,
                    termino_actividades_area_estudio:`${$('#finacthora').val() + ':' + $('#finactminuto').val()}`,
                    grupo_trabajo:`${$('#grupo_trabajo').val()}`,
                    fecha:`${$('#fecha').val()}`,
                    area_est_tramo:`${$('#tramo').val()}`,
                    area_est_sector:`${$('#sector').val()}`,
                    tipo_via:`${$('#tipovia').val()}`,
                    nombre:`${$('#nombrecalle').val()}`,
                    cuadras:`${$('#cuadras').val()}`,
                    referencia:`${$('#referencia').val()}`,
                    tipo_actividad:`${$('#tipoactividad').val()}`,
                    detalle_activ:`${$('#detalleact').val()}`,
                    equipo_utilizado:`${$('#equipo').val()}`,
                    especificar_equipo:`${$('#especificar').val()}`,
                    coordinaciones:`${$('#tipocoordinacion').val()}`,
                    detalle_coordinaciones:`${$('#detallecoordinacion').val()}`,
                    otrasincidencias:`${$('#incidencias').val()}`
                    };

        $.post(`${url_server}/actividadcampo`, datos, function(data) { 
          if ($.isEmptyObject(data))
          {
            app.dialog.alert("Se encontró problema al registrar la actividad.");
          }
          else
          {
            let txtMensaje = `Su reporte ${data.id} fue enviado con éxito.`
            app.dialog.alert(txtMensaje, function () {
              router.navigate('/menu/', {pushState: true});
            });
          }
        })
        .fail(function() {
          app.dialog.alert( "Se encontró un problema en la conexión.");
        })
        .always(function() {
          
        });

      },

    }


  }
</script>
