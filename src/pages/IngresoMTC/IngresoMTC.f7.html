<template>
  <div class="page">
    <div class="navbar color-theme-red">
      <div class="navbar-inner">
        <div class="left">
          <a href="#" class="link panel-open" data-panel="left">
            <i class="icon f7-icons if-ios">menu</i>
            <i class="icon material-icons if-md">menu</i>
          </a>
        </div>
        <div class="center">
          <span>Reporte de ingreso-salida del MTC</span> AVP
        </div>
      </div>
    </div>
    <div class="page-content">
      <div class="block">
        <div class="row">
          <a class="link" href="/menu/">
            <i class="material-icons">
              assignment_return
            </i>
            <span>Regresar al menú principal</span>
          </a>
        </div>

        <form class="list">
          <div class="block-title">PROFESIONAL</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">DNI</div>
                  <div class="item-input-wrap disabled">
                    <input id="dni" name="dni" type="text" placeholder="Ingrese el DNI">
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Nombre</div>
                  <div class="item-input-wrap disabled">
                    <input id="nombre" name="nombre" type="text" placeholder="Ingrese el nombre">
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">HORARIO DE INGRESO AL MTC (hacia destino)</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Hora de Ingreso</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="ingresohora" name="ingresohora" placeholder="Seleccione la hora...">
                    </select>
                  </div>
                </div>
                <div class="item-inner">
                  <div class="item-title item-label">Minuto de Ingreso</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="ingresominuto" name="ingresominuto" placeholder="Seleccione el minuto...">
                    </select>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">HORARIO DE SALIDA DEL MTC (regreso de campo)</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Hora de Salida</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="salidahora" name="salidahora" placeholder="Seleccione la hora...">
                    </select>
                  </div>
                </div>
                <div class="item-inner">
                  <div class="item-title item-label">Minuto de Salida</div>
                  <div class="item-input-wrap input-dropdown-wrap">
                    <select id="salidaminuto" name="salidaminuto" placeholder="Seleccione el minuto...">
                    </select>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        
          <div class="block-title">MOVILIDAD</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Nombre del conductor</div>
                  <div class="item-input-wrap">
                    <input id="nombreconductor" name="nombreconductor" type="text" placeholder="Ingrese el nombre del conductor">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Placa del vehículo</div>
                  <div class="item-input-wrap">
                    <input id="placavehiculo" name="placavehiculo" type="text" placeholder="Ingrese la placa del vehículo">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">DESTINO</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input id="destino" name="destino" type="text" placeholder="Ingrese el destino">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div class="block-title">OBJETO DE SALIDA</div>
          <div class="list inset">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input id="objetosalida" name="objetosalida" type="text" placeholder="Ingrese la finalidad de la salida">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        
        </form>
        <div class="list" style="padding: 20px;">
          <div class="text-align-center">
            Al hacer clic, declaro bajo juramento que los datos consignados en este formulario son correctos y completos sin omitir ni falsear dato alguno que deba contener, siendo expresión de la verdad.
          </div>
          <ul>
            <li>
              <span class="block">
              </span>
            </li>
            <li>
              <a id="btnregistrar" @click="registraringreso" class="col button button-raised button-fill button-round">Registrar ingreso</a>
            </li>
          </ul>
          <div class="block-footer">
  
          </div>
        </div>

      </div>
    </div>

  </div>
</template>
<script>
  import './css/mapa.css';
  import $ from "jquery";
  import {objectToString, StringToObject} from '../../helper'
  import {servers} from "../Login/servers";


  export default {
    created() {

    },
    on: {
      pageInit: function (event, page) {
        const app = this.$app;
        // llenar Horas
        for(var i = 0; i <= 23; i++) {
          var option = document.createElement('option');
          var option2 = document.createElement('option');
          option.textContent = (i < 10) ? ("0" + i) : i;
          option2.textContent = (i < 10) ? ("0" + i) : i;
          document.querySelector('#ingresohora').appendChild(option);
          document.querySelector('#salidahora').appendChild(option2);
          
        }
        // llenar Minutos
        for(var i = 0; i <= 59; i++) {
          var option = document.createElement('option');
          var option2 = document.createElement('option');
          option.textContent = (i < 10) ? ("0" + i) : i;
          option2.textContent = (i < 10) ? ("0" + i) : i;
          document.querySelector('#ingresominuto').appendChild(option);
          document.querySelector('#salidaminuto').appendChild(option2);
        }

        let config;
        let nrodni;
        if(localStorage.usuariopersonal != undefined){
          config = JSON.parse(localStorage.usuariopersonal);
          nrodni = config[0].dni;
          $('#dni').val(nrodni);
          $('#nombre').val(config[0].nombres_apellidos);
        }

        //colocar hora actual
        var d = new Date();
        var hour =  ("0" + (d.getHours())).slice(-2);
        $('#ingresohora').val(hour);
        var minute = ("0" + (d.getMinutes())).slice(-2);
        $('#ingresominuto').val(minute);

        //Revisar si hay reporte pendiente
        let url_server = `http://${servers[2].ipServidor}:${servers[2].puertoServidor}/api`;
        localStorage.setItem('ingresopendiente', 'false');
        $.get(`${url_server}/ingresodni/${nrodni}`, function(data) {
          if (!$.isEmptyObject(data))
          {
            app.dialog.confirm(`Su reporte ${data[0].id} tiene hora de salida pendiente, ¿desea finalizarlo?`, function () {
              localStorage.setItem('ingresopendiente', 'true');
              localStorage.setItem('idingreso', data[0].id);

              let arraytiempo = data[0].hora_ingreso.split(':');
              $('#ingresohora').val(arraytiempo[0]);
              $('#ingresominuto').val(arraytiempo[1]);

              $('#nombreconductor').val(data[0].nombre_conductor);
              $('#placa').val(data[0].placavehiculo);
              $('#destino').val(data[0].destino);
              $('#objeto_salida').val(data[0].objetosalida);
            }, function () {
            });
          }
        })
        .fail(function() {
          app.dialog.alert( "Se encontró un problema en la conexión." );
        });
      }
    },

    methods: {
      registraringreso() {

        const app = this.$app;
        const router = this.$router;

        app.dialog.confirm("¿Está seguro de enviar el reporte de ingreso/salida?", function () {
        }, function () {
          return false;
        });
        
        let url_server = `http://${servers[2].ipServidor}:${servers[2].puertoServidor}/api`;

        if(localStorage.ingresopendiente != undefined && localStorage.ingresopendiente == 'true'){
          let datosput = {id: `${localStorage.idingreso}`,
                          profesional:`${$('#nombre').val()}`,
                          dni:`${$('#dni').val()}`,
                          hora_ingreso:`${$('#ingresohora').val() + ':' + $('#ingresominuto').val()}`,
                          hora_salida:`${$('#salidahora').val() + ':' + $('#salidaminuto').val()}`,
                          nombre_conductor:`${$('#nombreconductor').val()}`,
                          placa:`${$('#placavehiculo').val()}`,
                          destino:`${$('#destino').val()}`,
                          objeto_salida:`${$('#objetosalida').val()}`,
                          lat:``,
                          lon:``
                          };

          $.ajax({
            url: `${url_server}/ingreso`,
            type: 'put',
            data: datosput
          })
          .done(function(data){
            if ($.isEmptyObject(data))
            {
              app.dialog.alert("Se encontró problema al registrar el ingreso.");
            }
            else
            {
              let txtMensaje = `Su reporte ${data.id} fue actualizado con éxito.`
              app.dialog.alert(txtMensaje, function () {
                router.navigate('/menu/', {pushState: true});
              });
            }
          }).fail( function() {
            app.dialog.alert( "Se encontró un problema en la conexión.");
          });

          return false;
        }

        let datos = {profesional:`${$('#nombre').val()}`,
                    dni:`${$('#dni').val()}`,
                    hora_ingreso:`${$('#ingresohora').val() + ':' + $('#ingresominuto').val()}`,
                    hora_salida:`${$('#salidahora').val() + ':' + $('#salidaminuto').val()}`,
                    nombre_conductor:`${$('#nombreconductor').val()}`,
                    placa:`${$('#placavehiculo').val()}`,
                    destino:`${$('#destino').val()}`,
                    objeto_salida:`${$('#objetosalida').val()}`,
                    lat:``,
                    lon:``
                    };

        $.post(`${url_server}/ingreso`, datos, function(data) { 
          if ($.isEmptyObject(data))
          {
            app.dialog.alert("Se encontró problema al registrar el ingreso.");
          }
          else
          {
            let txtMensaje = `Su reporte de ingreso ${data.id} fue enviado con éxito.`
            app.dialog.alert(txtMensaje, function () {
              router.navigate('/menu/', {pushState: true});
            });
          }
        })
        .fail(function() {
          app.dialog.alert( "Se encontró un problema en la conexión." );
        })
        .always(function() {
          
        });

      },
    }


  }
</script>